import{a as w,g as y,L as P,b as k,m,c as b}from"./index-gcSTJc4U.js";import{d as B,r as U}from"./index-gcSTJc4U.js";import{c as D}from"./createWalletClient-CQ1Cc0fE.js";import{c as W,s as O,a as S}from"./signer-pkp-KR-0I8aG.js";import{S as x}from"./signer-pkp-KR-0I8aG.js";async function v(){console.log("[Lit] Registering with WebAuthn...");const t=await w.WebAuthnAuthenticator.registerAndMintPKP({username:P.displayName,authServiceBaseUrl:P.authServiceUrl,scopes:["sign-anything"]});console.log("[Lit] PKP minted:",t.pkpInfo.ethAddress);const n={publicKey:t.pkpInfo.pubkey,ethAddress:t.pkpInfo.ethAddress,tokenId:t.pkpInfo.tokenId.toString()},a=await w.WebAuthnAuthenticator.authenticate();console.log("[Lit] WebAuthn authResult keys:",Object.keys(a)),console.log("[Lit] WebAuthn authResult full:",a);const o={...a};return console.log("[Lit] WebAuthn authData keys after spread:",Object.keys(o)),console.log("[Lit] Registration + authentication complete"),{pkpInfo:n,authData:o}}async function C(){var c;console.log("[Lit] Authenticating with WebAuthn...");const t=await w.WebAuthnAuthenticator.authenticate();console.log("[Lit] WebAuthn authResult keys:",Object.keys(t)),console.log("[Lit] WebAuthn authResult full:",t);const n={...t};console.log("[Lit] WebAuthn authData keys after spread:",Object.keys(n));const o=await(await y()).viewPKPsByAuthData({authData:{authMethodType:n.authMethodType,authMethodId:n.authMethodId},pagination:{limit:5,offset:0}});if(console.log("[Lit] Found PKPs:",o),!((c=o==null?void 0:o.pkps)!=null&&c.length))throw new Error("No PKP found for this credential. Please register first.");const i=o.pkps[0],h={publicKey:i.pubkey,ethAddress:i.ethAddress,tokenId:i.tokenId.toString()};return console.log("[Lit] Using PKP:",h.ethAddress),{pkpInfo:h,authData:n}}const L="https://lit-sponsorship-api.vercel.app";async function I(){const t=window.ethereum;if(!t)throw new Error("No wallet extension found. Please install MetaMask or another Ethereum wallet.");const n=await t.request({method:"eth_requestAccounts"});if(!n.length)throw new Error("No accounts available. Please unlock your wallet.");const a=k(n[0]);return D({account:a,chain:m,transport:b(t)})}async function N(t){var d,g,p;console.log("[Lit] Registering with EOA via relayer...");const n=t!=null?t:await I(),a=(d=n.account)==null?void 0:d.address;if(!a)throw new Error("No account address in wallet client");console.log("[Lit] Requesting PKP mint for EOA:",a),console.log("[Lit] Relayer URL:",L);const o=await fetch(`${L}/api/mint-user-pkp`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userAddress:a})});if(console.log("[Lit] Relayer response status:",o.status),!o.ok){const r=await o.json().catch(()=>({}));throw console.error("[Lit] Relayer API error:",r),new Error(r.error||`Failed to mint PKP: ${o.status}`)}const i=await o.json();console.log("[Lit] PKP minted via relayer:",{existing:i.existing,pkpEthAddress:i.pkpEthAddress});const h={publicKey:i.pkpPublicKey,ethAddress:i.pkpEthAddress,tokenId:i.pkpTokenId};console.log("[Lit] Creating EOA auth data via WalletClientAuthenticator..."),console.log("[Lit] This will prompt your wallet to sign a SIWE message");const c=typeof window<"u"?window.location.host:"localhost",l=typeof window<"u"?window.location.origin:"http://localhost",f=new Date(Date.now()+1e3*60*60*24).toISOString(),e=await w.WalletClientAuthenticator.authenticate(n,void 0,{domain:c,uri:l,statement:"Authorize Heaven session",expiration:f});console.log("[Lit] ✓ SIWE signature received from wallet"),console.log("[Lit] ✓ PKP registration complete");const u=await y();let s=await u.viewPKPsByAuthData({authData:{authMethodType:1,authMethodId:e.authMethodId},pagination:{limit:5,offset:0}});if(!((g=s==null?void 0:s.pkps)!=null&&g.length)){const r=a.toLowerCase();r!==e.authMethodId&&(console.warn("[Lit] No PKP found for authMethodId hash after register, retrying with address..."),s=await u.viewPKPsByAuthData({authData:{authMethodType:1,authMethodId:r},pagination:{limit:5,offset:0}}),(p=s==null?void 0:s.pkps)!=null&&p.length&&(e.authMethodId=r))}return console.log("[Lit] Registration authData keys:",Object.keys(e)),console.log("[Lit] Registration authData full:",e),{pkpInfo:h,authData:e,eoaAddress:a}}async function T(t){var d,g,p,r;console.log("[Lit] Authenticating with EOA...");const n=t!=null?t:await I(),a=(d=n.account)==null?void 0:d.address;if(!a)throw new Error("No account in wallet client");console.log("[Lit] Creating EOA auth data via WalletClientAuthenticator..."),console.log("[Lit] Wallet address:",a);const o=typeof window<"u"?window.location.host:"localhost",i=typeof window<"u"?window.location.origin:"http://localhost",h=new Date(Date.now()+1e3*60*60*24).toISOString();console.log("[Lit] SIWE params:",{domain:o,uri:i,expiration:h}),console.log("[Lit] Calling WalletClientAuthenticator.authenticate() — waiting for wallet signature...");const c=Date.now(),l=await w.WalletClientAuthenticator.authenticate(n,void 0,{domain:o,uri:i,statement:"Authorize Heaven session",expiration:h});console.log("[Lit] ✓ SIWE auth completed in",Date.now()-c,"ms"),console.log("[Lit] Getting Lit client...");const f=await y();console.log("[Lit] ✓ Lit client ready");let e=await f.viewPKPsByAuthData({authData:{authMethodType:1,authMethodId:l.authMethodId},pagination:{limit:5,offset:0}});if(!((g=e==null?void 0:e.pkps)!=null&&g.length)){const A=a.toLowerCase();A!==l.authMethodId&&(console.warn("[Lit] No PKP found for authMethodId hash, retrying with address..."),e=await f.viewPKPsByAuthData({authData:{authMethodType:1,authMethodId:A},pagination:{limit:5,offset:0}}),(p=e==null?void 0:e.pkps)!=null&&p.length&&(l.authMethodId=A))}if(console.log("[Lit] Found PKPs for EOA:",e),!((r=e==null?void 0:e.pkps)!=null&&r.length))throw new Error("No PKP found for this wallet. Please register first.");const u=e.pkps[0],s={publicKey:u.pubkey,ethAddress:u.ethAddress,tokenId:u.tokenId.toString()};return console.log("[Lit] Using PKP:",s.ethAddress),console.log("[Lit] Login authData keys:",Object.keys(l)),console.log("[Lit] Login authData full:",l),{pkpInfo:s,authData:l,eoaAddress:a}}export{P as LIT_CONFIG,x as SessionExpiredError,T as authenticateWithEOA,C as authenticateWithWebAuthn,S as clearAuthContext,W as createPKPAuthContext,B as getAuthManager,y as getLitClient,N as registerWithEOA,v as registerWithWebAuthn,U as resetClient,O as signMessageWithPKP};
