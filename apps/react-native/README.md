# Lit Protocol React Native POC - Android + iOS

**Goal**: Test whether Lit Protocol's WebAuthn flow works in a React Native app:
- Android: embedded WebView
- iOS: system browser auth session (not WebView)

## What This Tests

The core Lit Protocol WebAuthn authentication flow:
1. **Register** a new WebAuthn credential using device biometrics (fingerprint/face unlock)
2. **Mint a PKP** (Programmable Key Pair) tied to that credential
3. **View PKPs** by auth data
4. **Create Auth Context** for signing operations

## Architecture

### Hybrid Approach: WebView Bridge (Android)
- **WebView**: Runs Lit Protocol's browser packages (`@lit-protocol/lit-client`, `@lit-protocol/auth`)
- **React Native**: Provides UI and communicates with WebView via message bridge
- **Secure Context**: WebView served from `https://appassets.androidplatform.net/assets/...` using `WebViewAssetLoader` to enable WebCrypto
- **WebAuthn**: Enabled via AndroidX WebKit (`WebSettingsCompat.setWebAuthenticationSupport`) when supported

### iOS Path (System Browser)
- WebAuthn runs in system browser via `expo-web-browser`
- App receives results via deep link (`litrnpoc://webauthn-callback`)
- Requires a hosted HTTPS page that performs WebAuthn and redirects back

### Why This Approach?
- Lit Protocol v8 packages are designed for browsers (need `crypto.subtle`, WebAuthn APIs)
- React Native doesn't have native WebAuthn support
- WebView provides the browser environment while staying embedded in the app

## Project Structure

```
├── lit-webview/              # Browser bundle (Vite build)
│   ├── src/index.ts          # Lit engine + bridge protocol
│   └── public/index.html     # WebView entry point
├── src/
│   ├── services/LitBridge.ts # RN ↔ WebView communication
│   ├── components/LitWebView.tsx  # Headless WebView component
│   └── providers/LitProvider.tsx  # React context
├── App.tsx                   # Test UI with 4 buttons
└── android/                  # Generated by Expo prebuild
```

## Building & Testing

### 1. Install Dependencies
```bash
bun install
cd lit-webview && bun install && cd ..
```

### 2. Build the WebView Bundle
```bash
cd lit-webview && bun run build && cd ..
```

This creates:
- `android/app/src/main/assets/lit-bundle/lit-engine.js` (~36MB, 3MB gzipped)
- `android/app/src/main/assets/lit-bundle/index.html`

### 3. Generate Native Android Project
```bash
npx expo prebuild --platform android
```

### 4. Build APK (Release)
```bash
cd android && ./gradlew assembleRelease && cd ..
```

APK location: `android/app/build/outputs/apk/release/app-release.apk`

### 5. Install on Device
```bash
adb install -r android/app/build/outputs/apk/release/app-release.apk
```

Or drag & drop the APK to your device.

## Testing the App

The app shows 4 buttons:

1. **Register + Mint PKP**
   - Triggers WebAuthn registration (fingerprint/face prompt)
   - Mints a new PKP on Lit's naga-dev network
   - Each credential is bound to ONE PKP

2. **Authenticate (existing)**
   - Use if you already registered a credential
   - Authenticates with existing WebAuthn credential

3. **View PKPs**
   - Shows all PKPs associated with your auth method
   - Requires auth data from step 1 or 2

4. **Create Auth Context**
   - Generates session keys for signing
   - Caches delegation auth sig
   - Requires PKP info + auth data

### What to Look For

✅ **Success indicators:**
- Environment check shows: `Secure Context: ✅` and `WebCrypto: ✅`
- Step 1 prompts for fingerprint/face unlock
- PKP public key appears in logs
- All 4 steps complete without errors

❌ **Failure indicators:**
- `WebCrypto not available` - WebViewAssetLoader not configured correctly
- `NotAllowedError` - WebAuthn not working in WebView context
- Timeout errors - Network or Lit service issues

## Key Implementation Details

### Secure Context Setup
Android WebViews need secure context for `crypto.subtle`:
- Serve assets from `https://appassets.androidplatform.net/`
- Configure `WebViewAssetLoader` in MainActivity (via Expo plugin)
- Localhost is NOT considered secure on Android WebView by default

### Bridge Protocol
JSON-based request/response:
```typescript
// RN → WebView
{ id: "req-1", op: "registerAndMintPKP", payload: { authServiceBaseUrl: "...", scopes: [...] } }

// WebView → RN
{ id: "req-1", ok: true, result: { pkpInfo: {...}, webAuthnPublicKey: "..." } }
```

### Storage
- WebView proxies storage to React Native
- RN uses `@react-native-async-storage/async-storage`
- Stores session keys and auth context
- Prefix: `lit:*`

## Troubleshooting

**WebCrypto not available:**
- Check WebView is loading from `https://appassets.androidplatform.net/`
- Verify `WebViewAssetLoader` is configured in MainActivity
- Enable WebView debugging: `chrome://inspect/#devices`

**WebAuthn not working (Android WebView):**
- Ensure device has biometric authentication enabled
- Check Android version >= 9 (API 28) for WebAuthn support
- Try on real device (emulator biometrics can be flaky)
- WebView must support WebAuthn (`androidx.webkit` 1.12+); this project uses 1.14.0
- HTTPS origin is required; some devices may require Digital Asset Links for passkeys

**iOS WebAuthn not working:**
- WebAuthn is not supported inside WKWebView
- Use system browser flow via `expo-web-browser`
- Host a real HTTPS page and set `EXPO_PUBLIC_WEB_AUTHN_URL`

**Bundle not found:**
- Re-run `cd lit-webview && bun run build`
- Check `android/app/src/main/assets/lit-bundle/` exists
- Clean build: `cd android && ./gradlew clean && ./gradlew assembleDebug`

## Network

Currently using **naga-dev** (Lit's test network):
- Auth service: `https://naga-dev-auth-service.getlit.dev`
- Free to use, no API keys needed
- Test PKPs, don't use for production

## iOS Setup Notes

### Required env var
Set the hosted WebAuthn page for iOS:
```
EXPO_PUBLIC_WEB_AUTHN_URL=https://yourdomain.com/lit-webauthn
```

### Callback contract (iOS)
Your hosted page must redirect back to:
```
litrnpoc://webauthn-callback?authMethodId=...&pkpPublicKey=...
```

## Implementation Notes

- WebAuthn-in-WebView enablement is patched into `react-native-webview` (node_modules).
  If you reinstall deps, reapply the patch or add `patch-package`.
- Buffer polyfill is injected in `lit-webview/src/index.ts` to decode WebAuthn responses.

## Next Steps

If this POC works:
1. Extract into reusable library
2. Add iOS support (different secure context approach)
3. Implement full PKP signing operations
4. Add encrypt/decrypt flows
5. Production network configuration

## References

- [Lit Protocol Docs](https://developer.litprotocol.com/)
- [WebAuthn on Android](https://developer.android.com/identity/sign-in/credential-manager)
- [WebViewAssetLoader](https://developer.android.com/reference/androidx/webkit/WebViewAssetLoader)
- [React Native WebView](https://github.com/react-native-webview/react-native-webview)
