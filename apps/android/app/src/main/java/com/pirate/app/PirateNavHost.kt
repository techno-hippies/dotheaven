package com.pirate.app

import androidx.compose.animation.EnterTransition
import androidx.compose.animation.ExitTransition
import androidx.compose.foundation.layout.PaddingValues
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.padding
import androidx.compose.runtime.Composable
import androidx.compose.runtime.remember
import androidx.compose.runtime.rememberCoroutineScope
import androidx.compose.ui.Modifier
import androidx.navigation.compose.NavHost
import com.pirate.app.auth.PirateAuthUiState
import com.pirate.app.chat.XmtpChatService
import com.pirate.app.player.PlayerController
import com.pirate.app.profile.FollowListMode
import com.pirate.app.profile.PublishedSongRow
import com.pirate.app.scarlett.AgoraVoiceController
import com.pirate.app.scarlett.ScarlettService
import com.pirate.app.schedule.ScheduledSessionVoiceController
import com.pirate.app.tempo.TempoAccountFactory
import com.pirate.app.tempo.TempoPasskeyManager
import kotlinx.coroutines.CoroutineScope

internal data class PirateNavHostContext(
  val activity: androidx.fragment.app.FragmentActivity,
  val navController: androidx.navigation.NavHostController,
  val authState: PirateAuthUiState,
  val activeAddress: String?,
  val heavenName: String?,
  val avatarUri: String?,
  val tempoAccount: TempoPasskeyManager.PasskeyAccount?,
  val onAuthStateChange: (PirateAuthUiState) -> Unit,
  val onRegister: () -> Unit,
  val onLogin: () -> Unit,
  val onLogout: () -> Unit,
  val onOpenDrawer: () -> Unit,
  val onShowMessage: (String) -> Unit,
  val onRefreshProfileIdentity: () -> Unit,
  val onChatThreadVisibilityChange: (Boolean) -> Unit,
  val onboardingInitialStep: com.pirate.app.onboarding.OnboardingStep,
  val player: PlayerController,
  val chatService: XmtpChatService,
  val scarlettService: ScarlettService,
  val voiceController: AgoraVoiceController,
  val scheduledSessionVoiceController: ScheduledSessionVoiceController,
  val scope: CoroutineScope,
  val openSongRoute: (String, String?, String?) -> Unit,
  val openArtistRoute: (String) -> Unit,
  val openPublicProfileRoute: (String) -> Unit,
  val openFollowListRoute: (FollowListMode, String) -> Unit,
  val playPublishedSong: (PublishedSongRow) -> Unit,
)

@Composable
internal fun PirateNavHost(
  activity: androidx.fragment.app.FragmentActivity,
  innerPadding: PaddingValues,
  navController: androidx.navigation.NavHostController,
  authState: PirateAuthUiState,
  heavenName: String?,
  avatarUri: String?,
  onAuthStateChange: (PirateAuthUiState) -> Unit,
  onRegister: () -> Unit,
  onLogin: () -> Unit,
  onLogout: () -> Unit,
  player: PlayerController,
  chatService: XmtpChatService,
  scarlettService: ScarlettService,
  voiceController: AgoraVoiceController,
  scheduledSessionVoiceController: ScheduledSessionVoiceController,
  onOpenDrawer: () -> Unit,
  onShowMessage: (String) -> Unit,
  onRefreshProfileIdentity: () -> Unit,
  onChatThreadVisibilityChange: (Boolean) -> Unit,
  onboardingInitialStep: com.pirate.app.onboarding.OnboardingStep = com.pirate.app.onboarding.OnboardingStep.NAME,
) {
  val scope = rememberCoroutineScope()
  val activeAddress = authState.activeAddress()
  val tempoAccount = remember(
    authState.tempoAddress,
    authState.tempoCredentialId,
    authState.tempoPubKeyX,
    authState.tempoPubKeyY,
    authState.tempoRpId,
  ) {
    TempoAccountFactory.fromSession(
      tempoAddress = authState.tempoAddress,
      tempoCredentialId = authState.tempoCredentialId,
      tempoPubKeyX = authState.tempoPubKeyX,
      tempoPubKeyY = authState.tempoPubKeyY,
      tempoRpId = authState.tempoRpId.ifBlank { TempoPasskeyManager.DEFAULT_RP_ID },
    )
  }

  val openSongRoute: (String, String?, String?) -> Unit = { trackId, title, artist ->
    navController.navigate(
      PirateRoute.Song.buildRoute(trackId = trackId, title = title, artist = artist),
    ) { launchSingleTop = true }
  }
  val openArtistRoute: (String) -> Unit = { artistName ->
    navController.navigate(PirateRoute.Artist.buildRoute(artistName)) { launchSingleTop = true }
  }
  val openPublicProfileRoute: (String) -> Unit = { address ->
    navController.navigate(PirateRoute.PublicProfile.buildRoute(address)) { launchSingleTop = true }
  }
  val openFollowListRoute: (FollowListMode, String) -> Unit = { mode, address ->
    navController.navigate(PirateRoute.FollowList.buildRoute(address, mode)) { launchSingleTop = true }
  }
  val playPublishedSong: (PublishedSongRow) -> Unit = { song ->
    val audioUrl = com.pirate.app.music.CoverRef.resolveCoverUrl(
      song.pieceCid,
      width = null,
      height = null,
      format = null,
      quality = null,
    )
    if (audioUrl.isNullOrBlank()) {
      onShowMessage("No audio available for this track")
    } else {
      val coverUrl = com.pirate.app.music.CoverRef.resolveCoverUrl(
        song.coverCid,
        width = 192,
        height = 192,
        format = "webp",
        quality = 80,
      )
      val track = com.pirate.app.music.MusicTrack(
        id = song.contentId,
        title = song.title.ifBlank { "Unknown Track" },
        artist = song.artist.ifBlank { "Unknown Artist" },
        album = song.album,
        durationSec = song.durationSec,
        uri = audioUrl,
        filename = song.title.ifBlank { "track" },
        artworkUri = coverUrl,
        contentId = song.contentId,
        pieceCid = song.pieceCid,
      )
      player.playTrack(track, listOf(track))
    }
  }

  val context = PirateNavHostContext(
    activity = activity,
    navController = navController,
    authState = authState,
    activeAddress = activeAddress,
    heavenName = heavenName,
    avatarUri = avatarUri,
    tempoAccount = tempoAccount,
    onAuthStateChange = onAuthStateChange,
    onRegister = onRegister,
    onLogin = onLogin,
    onLogout = onLogout,
    onOpenDrawer = onOpenDrawer,
    onShowMessage = onShowMessage,
    onRefreshProfileIdentity = onRefreshProfileIdentity,
    onChatThreadVisibilityChange = onChatThreadVisibilityChange,
    onboardingInitialStep = onboardingInitialStep,
    player = player,
    chatService = chatService,
    scarlettService = scarlettService,
    voiceController = voiceController,
    scheduledSessionVoiceController = scheduledSessionVoiceController,
    scope = scope,
    openSongRoute = openSongRoute,
    openArtistRoute = openArtistRoute,
    openPublicProfileRoute = openPublicProfileRoute,
    openFollowListRoute = openFollowListRoute,
    playPublishedSong = playPublishedSong,
  )

  NavHost(
    navController = navController,
    startDestination = PirateRoute.Music.route,
    modifier = Modifier.fillMaxSize().padding(innerPadding),
    // nav-compose ships with default fades; opt out so Player can feel like a real "page open".
    enterTransition = { EnterTransition.None },
    exitTransition = { ExitTransition.None },
    popEnterTransition = { EnterTransition.None },
    popExitTransition = { ExitTransition.None },
  ) {
    registerPrimaryRoutes(context)
    registerProfileRoutes(context)
    registerModalRoutes(context)
  }
}
