name: Deploy Services Dev

on:
  workflow_dispatch:
    inputs:
      run_smoke:
        description: "Run post-deploy services smoke checks"
        required: false
        default: "true"

concurrency:
  group: deploy-services-dev
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: api-core
            cwd: services/api-core
          - service: metadata-resolver
            cwd: services/metadata-resolver
          - service: voice-agent
            cwd: services/voice-agent
          - service: voice-control-plane
            cwd: services/voice-control-plane

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.8"

      - name: Install dependencies
        working-directory: ${{ matrix.cwd }}
        run: bun install

      - name: Deploy ${{ matrix.service }}
        working-directory: ${{ matrix.cwd }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: bun run deploy

  smoke:
    needs: deploy
    if: ${{ inputs.run_smoke != 'false' }}
    uses: ./.github/workflows/services-smoke.yml
    secrets: inherit
