name = "heaven-api"
main = "src/index.ts"
compatibility_date = "2024-09-23"
compatibility_flags = ["nodejs_compat"]

# Rules for bundling WASM modules
[[rules]]
type = "CompiledWasm"
globs = ["**/*.wasm"]

# Rules for font files (binary data)
[[rules]]
type = "Data"
globs = ["**/*.ttf", "**/*.otf", "**/*.woff", "**/*.woff2"]

# KV namespace for resolver cache (MBID lookups, ISRC results, AcoustID, search)
# [[kv_namespaces]]
# binding = "RESOLVER_KV"
# id = "TODO_CREATE_KV_NAMESPACE"
# preview_id = "TODO_CREATE_KV_NAMESPACE"

[vars]
ENVIRONMENT = "development"
BASE_SEPOLIA_RPC = "https://sepolia.base.org"

# Scrobble resolver config
MB_USER_AGENT = "Heaven/1.0 (heaven.computer)"
ACOUSTID_CLIENT_KEY = ""
ENABLE_MB_FALLBACK_SEARCH = "false"
# DNS_SHARED_SECRET = "your-secret-here"  # Set via wrangler secret for production
# CLAIM_START_SECRET = "your-secret-here" # Required in production to call /api/claim/start
# FAL_KEY = "your-fal-key"  # Set via wrangler secret
# BASE_SEPOLIA_RELAY_PK = "..."  # Set via wrangler secret for EAS attestations
# STORY_SPONSOR_PRIVATE_KEY = "0x..." # Optional; falls back to PRIVATE_KEY if unset
# STORY_RPC_URL = "https://aeneid.storyrpc.io"
# STORY_CHAIN_ID = "1315"
# STORY_SPG_NFT_CONTRACT = "0xb1764abf89e6a151ea27824612145ef89ed70a73"
# STORY_LICENSE_ATTACHMENT_WORKFLOWS = "0xcC2E862bCee5B6036Db0de6E06Ae87e524a79fd8"
# STORY_DERIVATIVE_WORKFLOWS = "0x9e2d496f72C547C2C535B167e06ED8729B374a4f"
# STORY_IP_ASSET_REGISTRY = "0x77319B4031e6eF1250907aa00018B8B1c67a244b"
# STORY_LICENSE_REGISTRY = "0x529a750E02d8E2f15649c13D69a465286a780e24"
# STORY_ROYALTY_POLICY_LAP = "0xBe54FB168b3c982b7AaE60dB6CF75Bd8447b390E"
# STORY_WIP_TOKEN = "0x1514000000000000000000000000000000000000"
# STORY_PIL_LICENSE_TEMPLATE = "0x2E896b0b2Fdb7457499B56AAaA4AE55BCB4Cd316"
# FILEBASE_KEY = "ACCESS_KEY:SECRET_KEY:BUCKET"  # Set via wrangler secret for IPFS pinning

# Self.xyz verification
SELF_SCOPE = "heaven"
SELF_ENDPOINT = "https://heaven-api.deletion-backup782.workers.dev/api/self/verify"
SELF_MOCK_PASSPORT = "true"  # Set to "false" for production

# Tempo music publish finalize â€” ContentRegistry on MegaETH testnet
TEMPO_CONTENT_REGISTRY = "0x9ca08C2D2170A43ecfA12AB35e06F2E1cEEB4Ef2"
# TEMPO_CANONICAL_LYRICS_REGISTRY = "0x..." # Canonical lyrics refs for study generation
TEMPO_STUDY_SET_REGISTRY = "0x7fD583d6e9D2F820432455D071617b5C1449c7a4" # StudySetRegistryV1 for on-chain pack refs

# Tempo names anti-squat policy
TEMPO_NAME_REGISTRY_V2 = "0xA111c5cA16752B09fF16B3B8B24BA55a8486aB23"
TEMPO_PREMIUM_NAME_STORE_V2 = "0x46Bcae2625157b562c974bb5a912dfcb811a234A"
TEMPO_HEAVEN_NODE = "0x8edf6f47e89d05c0e21320161fda1fd1fabd0081a66c959691ea17102e39fb27"
TEMPO_PIRATE_NODE = "0xace9c9c435cf933be3564cdbcf7b7e2faee63e4f39034849eacb82d13f32f02a"
# TEMPO_POLICY_SIGNER_PRIVATE_KEY = "0x..."   # Backend signing key for NamePermit EIP-712
TEMPO_POLICY_SIGNER_ADDRESS = "0xc77Ad4de7d179FFFBa417cA24c055d86Af69F4BB"
# NAMES_PERMIT_TTL_SECONDS = "180"
# NAMES_POW_TTL_SECONDS = "300"
# NAMES_POW_DIFFICULTY_HEX = "4"
# NAMES_LONG_WALLET_LIMIT_10M = "8"
# NAMES_LONG_IP_LIMIT_10M = "24"
# NAMES_LONG_DEVICE_LIMIT_10M = "12"

[[d1_databases]]
binding = "DB"
database_name = "heaven-api"
database_id = "6c7c6c73-29c5-4886-b511-3bf4332bca09"

# R2 buckets for photo pipeline (using same buckets for dev/prod for now)
[[r2_buckets]]
binding = "R2_RAW"
bucket_name = "heaven-raw"
preview_bucket_name = "heaven-raw"

[[r2_buckets]]
binding = "R2_ORIG"
bucket_name = "heaven-orig"
preview_bucket_name = "heaven-orig"

[[r2_buckets]]
binding = "R2_ANIME"
bucket_name = "heaven-anime"
preview_bucket_name = "heaven-anime"

[[r2_buckets]]
binding = "R2_REVEAL"
bucket_name = "heaven-reveal"
preview_bucket_name = "heaven-reveal"

[[r2_buckets]]
binding = "R2_WM"
bucket_name = "heaven-wm"
preview_bucket_name = "heaven-wm"

# Images binding for transforms (EXIF strip, trim, resize, watermark)
[images]
binding = "IMAGES"

[env.production]
vars = { ENVIRONMENT = "production", SELF_MOCK_PASSPORT = "false", SELF_SCOPE = "heaven", SELF_ENDPOINT = "https://heaven-api.deletion-backup782.workers.dev/api/self/verify" }

# Production uses same database (single environment for now)
[[env.production.d1_databases]]
binding = "DB"
database_name = "heaven-api"
database_id = "6c7c6c73-29c5-4886-b511-3bf4332bca09"

# Production R2 buckets
[[env.production.r2_buckets]]
binding = "R2_RAW"
bucket_name = "heaven-raw"

[[env.production.r2_buckets]]
binding = "R2_ORIG"
bucket_name = "heaven-orig"

[[env.production.r2_buckets]]
binding = "R2_ANIME"
bucket_name = "heaven-anime"

[[env.production.r2_buckets]]
binding = "R2_REVEAL"
bucket_name = "heaven-reveal"

[[env.production.r2_buckets]]
binding = "R2_WM"
bucket_name = "heaven-wm"

[env.production.images]
binding = "IMAGES"
