# Caddy configuration for automatic HTTPS
# The DOMAIN environment variable will be injected at runtime

{$DOMAIN:localhost} {
    tls /run/tls/fullchain.pem /run/tls/privkey.pem

    reverse_proxy localhost:{$APP_PORT:8080}

    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }

    log {
        output stdout
        format console
        level INFO
    }

    request_body {
        max_size 10MB
    }
}

:80 {
    @for_domain expression {host} != "localhost"
    redir @for_domain https://{host}{uri} permanent

    handle /health {
        reverse_proxy localhost:{$APP_PORT:8080}
    }
}
